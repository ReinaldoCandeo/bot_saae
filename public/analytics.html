<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìä Analytics - Bot WhatsApp</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .stat-card .icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .stat-card .label {
            color: #666;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }

        .stat-card .value {
            color: #333;
            font-size: 2.5em;
            font-weight: bold;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .chart-card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        .table-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #667eea;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }

        tr:hover {
            background: #f8f9ff;
        }

        .refresh-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            margin: 20px 0;
        }

        .refresh-btn:hover {
            background: #5568d3;
            transform: scale(1.05);
        }

        .time-filter {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .time-filter button {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .time-filter button.active {
            background: #667eea;
            color: white;
        }

        .time-filter button:hover {
            transform: scale(1.05);
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Analytics do Bot WhatsApp</h1>
            <p>Estat√≠sticas de Demanda e Uso</p>
            
            <div class="time-filter">
                <button class="active" onclick="changeFilter('today')">Hoje</button>
                <button onclick="changeFilter('week')">7 Dias</button>
                <button onclick="changeFilter('month')">30 Dias</button>
                <button onclick="changeFilter('all')">Tudo</button>
            </div>
            
            <button class="refresh-btn" onclick="loadData()">üîÑ Atualizar Dados</button>
        </div>

        <!-- Cards de Estat√≠sticas -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="icon">üí¨</div>
                <div class="label">Total de Mensagens</div>
                <div class="value" id="totalMessages">-</div>
            </div>
            
            <div class="stat-card">
                <div class="icon">üë•</div>
                <div class="label">Usu√°rios √önicos</div>
                <div class="value" id="uniqueUsers">-</div>
            </div>
            
            <div class="stat-card">
                <div class="icon">üìÖ</div>
                <div class="label">Agendamentos</div>
                <div class="value" id="totalAppointments">-</div>
            </div>
            
            <div class="stat-card">
                <div class="icon">üî•</div>
                <div class="label">Servi√ßo Mais Usado</div>
                <div class="value" id="topService" style="font-size: 1.5em;">-</div>
            </div>
        </div>

        <!-- Gr√°ficos -->
        <div class="charts-grid">
            <!-- Demanda por Servi√ßo -->
            <div class="chart-card">
                <h2>üìã Demanda por Servi√ßo</h2>
                <div class="chart-container">
                    <canvas id="serviceChart"></canvas>
                </div>
            </div>

            <!-- Agendamentos por Tipo -->
            <div class="chart-card">
                <h2>üìÖ Agendamentos por Tipo</h2>
                <div class="chart-container">
                    <canvas id="appointmentChart"></canvas>
                </div>
            </div>

            <!-- Mensagens por Hora -->
            <div class="chart-card">
                <h2>‚è∞ Hor√°rios de Pico</h2>
                <div class="chart-container">
                    <canvas id="hourlyChart"></canvas>
                </div>
            </div>

            <!-- Mensagens por Dia da Semana -->
            <div class="chart-card">
                <h2>üìÜ Demanda por Dia da Semana</h2>
                <div class="chart-container">
                    <canvas id="weekdayChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Tabela de Agendamentos Recentes -->
        <div class="table-card">
            <h2 style="color: #667eea; margin-bottom: 20px;">üìã Agendamentos Recentes</h2>
            <table id="appointmentsTable">
                <thead>
                    <tr>
                        <th>Protocolo</th>
                        <th>Servi√ßo</th>
                        <th>Cliente</th>
                        <th>Data Agendada</th>
                        <th>Status</th>
                        <th>Criado em</th>
                    </tr>
                </thead>
                <tbody id="appointmentsBody">
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 30px;">
                            Carregando dados...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Tabela de Servi√ßos Mais Acessados -->
        <div class="table-card">
            <h2 style="color: #667eea; margin-bottom: 20px;">üî• Top 10 Servi√ßos Mais Acessados</h2>
            <table id="topServicesTable">
                <thead>
                    <tr>
                        <th>Posi√ß√£o</th>
                        <th>Servi√ßo</th>
                        <th>Acessos</th>
                        <th>Porcentagem</th>
                    </tr>
                </thead>
                <tbody id="topServicesBody">
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 30px;">
                            Carregando dados...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let currentFilter = 'today';
        let charts = {};

        // Configura√ß√£o dos gr√°ficos
        const chartColors = {
            primary: '#667eea',
            secondary: '#764ba2',
            success: '#10b981',
            warning: '#f59e0b',
            danger: '#ef4444',
            info: '#3b82f6'
        };

        // Mudar filtro de tempo
        function changeFilter(filter) {
            currentFilter = filter;
            document.querySelectorAll('.time-filter button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            loadData();
        }

        // Carregar dados
        async function loadData() {
            try {
                const response = await fetch(`/api/analytics?filter=${currentFilter}`);
                const data = await response.json();
                
                updateStats(data.stats);
                updateCharts(data);
                updateTables(data);
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
            }
        }

        // Atualizar estat√≠sticas
        function updateStats(stats) {
            document.getElementById('totalMessages').textContent = stats.totalMessages || 0;
            document.getElementById('uniqueUsers').textContent = stats.uniqueUsers || 0;
            document.getElementById('totalAppointments').textContent = stats.totalAppointments || 0;
            document.getElementById('topService').textContent = stats.topService || '-';
        }

        // Atualizar gr√°ficos
        function updateCharts(data) {
            // Gr√°fico de Demanda por Servi√ßo
            updateServiceChart(data.serviceData);
            
            // Gr√°fico de Agendamentos
            updateAppointmentChart(data.appointmentData);
            
            // Gr√°fico de Mensagens por Hora
            updateHourlyChart(data.hourlyData);
            
            // Gr√°fico por Dia da Semana
            updateWeekdayChart(data.weekdayData);
        }

        // Gr√°fico de Servi√ßos
        function updateServiceChart(data) {
            const ctx = document.getElementById('serviceChart').getContext('2d');
            
            if (charts.service) {
                charts.service.destroy();
            }
            
            charts.service = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.labels,
                    datasets: [{
                        data: data.values,
                        backgroundColor: [
                            chartColors.primary,
                            chartColors.secondary,
                            chartColors.success,
                            chartColors.warning,
                            chartColors.danger
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        title: {
                            display: false
                        }
                    }
                }
            });
        }

        // Gr√°fico de Agendamentos
        function updateAppointmentChart(data) {
            const ctx = document.getElementById('appointmentChart').getContext('2d');
            
            if (charts.appointment) {
                charts.appointment.destroy();
            }
            
            charts.appointment = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Agendamentos',
                        data: data.values,
                        backgroundColor: chartColors.primary
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        // Gr√°fico por Hora
        function updateHourlyChart(data) {
            const ctx = document.getElementById('hourlyChart').getContext('2d');
            
            if (charts.hourly) {
                charts.hourly.destroy();
            }
            
            charts.hourly = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Mensagens',
                        data: data.values,
                        borderColor: chartColors.primary,
                        backgroundColor: chartColors.primary + '20',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Gr√°fico por Dia da Semana
        function updateWeekdayChart(data) {
            const ctx = document.getElementById('weekdayChart').getContext('2d');
            
            if (charts.weekday) {
                charts.weekday.destroy();
            }
            
            charts.weekday = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Mensagens',
                        data: data.values,
                        backgroundColor: [
                            chartColors.danger,
                            chartColors.primary,
                            chartColors.primary,
                            chartColors.primary,
                            chartColors.primary,
                            chartColors.primary,
                            chartColors.danger
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Atualizar tabelas
        function updateTables(data) {
            // Tabela de agendamentos
            const appointmentsBody = document.getElementById('appointmentsBody');
            
            if (data.recentAppointments && data.recentAppointments.length > 0) {
                appointmentsBody.innerHTML = data.recentAppointments.map(apt => `
                    <tr>
                        <td><strong>${apt.protocol}</strong></td>
                        <td>${apt.service_type_label}</td>
                        <td>${apt.customer_name}</td>
                        <td>${apt.scheduled_date}</td>
                        <td><span style="color: ${getStatusColor(apt.status)}">${getStatusLabel(apt.status)}</span></td>
                        <td>${formatDate(apt.created_at)}</td>
                    </tr>
                `).join('');
            } else {
                appointmentsBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 30px;">Nenhum agendamento encontrado</td></tr>';
            }

            // Tabela de top servi√ßos
            const topServicesBody = document.getElementById('topServicesBody');
            
            if (data.topServices && data.topServices.length > 0) {
                const total = data.topServices.reduce((sum, s) => sum + s.count, 0);
                topServicesBody.innerHTML = data.topServices.map((service, index) => {
                    const percentage = ((service.count / total) * 100).toFixed(1);
                    return `
                        <tr>
                            <td style="text-align: center; font-size: 1.5em;">${getMedal(index)}</td>
                            <td><strong>${service.service}</strong></td>
                            <td><strong>${service.count}</strong></td>
                            <td>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div style="flex: 1; background: #eee; height: 20px; border-radius: 10px; overflow: hidden;">
                                        <div style="width: ${percentage}%; background: ${chartColors.primary}; height: 100%;"></div>
                                    </div>
                                    <span><strong>${percentage}%</strong></span>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            } else {
                topServicesBody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 30px;">Nenhum dado dispon√≠vel</td></tr>';
            }
        }

        // Helpers
        function getMedal(index) {
            const medals = ['ü•á', 'ü•à', 'ü•â'];
            return medals[index] || `${index + 1}¬∫`;
        }

        function getStatusColor(status) {
            const colors = {
                'pending': '#f59e0b',
                'confirmed': '#10b981',
                'cancelled': '#ef4444',
                'completed': '#3b82f6'
            };
            return colors[status] || '#666';
        }

        function getStatusLabel(status) {
            const labels = {
                'pending': '‚è≥ Pendente',
                'confirmed': '‚úÖ Confirmado',
                'cancelled': '‚ùå Cancelado',
                'completed': 'üéâ Conclu√≠do'
            };
            return labels[status] || status;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Carregar dados ao iniciar
        loadData();

        // Auto-refresh a cada 30 segundos
        setInterval(loadData, 30000);
    </script>
</body>
</html>

